# 功能規格：統一滑雪者身份核心（Unified Rider Identity Core）

**功能分支**: `001-user-core-identity`  
**建立日期**: 2025-10-14  
**狀態**: 實作中（部分功能於 2025-10-19 落地）  
**來源**: 來自 `mindmap.md` + `LINUS_GUIDE.md` 原則

## 使用者情境與測試（強制）

### 使用者故事 1 - 建立與維護單一使用者檔案（優先度：P1）

教練或營運人員能以一次操作建立／更新滑雪者的主檔資料，系統自動同步角色、語言與滑雪經驗供其他服務使用。

**為何此優先**：沒有可靠主檔，其餘專案無法正確串接資料。

**獨立測試**：透過建立新使用者並檢查主檔 API／資料表是否立即可供讀取，確認對其他專案無需額外流程即可引用。

**驗收情境**：

1. **Given** 新使用者資料完整，**When** 營運人員建立主檔，**Then** 系統生成唯一 `User ID` 並儲存所有基本欄位。
2. **Given** 既有使用者需要新增「教練」身份，**When** 更新角色標記，**Then** 系統同時記錄變更時間並通知依賴專案。

---

### 使用者故事 2 - 統一行為事件記錄（優先度：P2）

任何子專案都能向 user-core 註冊行為事件（例如排課、媒合、裝備檢查），並以統一 schema 儲存供後續查詢。

**為何此優先**：行為事件是跨專案追蹤的基礎，能量測使用與觸發推播。

**獨立測試**：以模擬服務呼叫事件寫入 API，驗證資料以標準欄位存儲並可依 `User ID` 查詢。

**驗收情境**：

1. **Given** 子專案送出包含事件類型與 payload 的請求，**When** user-core 接收，**Then** 系統驗證 schema 並儲存帶有時間戳的事件。
2. **Given** 查詢特定 `User ID` 的事件歷史，**When** 讀取接口被調用，**Then** 回傳依時間排序且含事件來源的資料。

#### 事件 schema 治理（混合模式）
- 核心事件（跨專案共用、納入分析指標者）由 user-core 維護 schema registry，並於寫入時在 user-core 驗證（`event_type × version`）。
- 核心事件清單與欄位定義記錄於 `specs/shared/event_catalog.yaml`，新增或升級需先更新該型錄。
- 自定義事件由各子專案自行維護與驗證；可選擇上報 `schema_url` 與 `version` 作為追溯資訊。
- 最低欄位規範：所有事件必須包含 `event_type`、`version`、`source_project`、`occurred_at`、`payload`。

#### 事件查詢（排序與過濾）
- 呼叫端必須顯式指定排序欄位：`sort_by ∈ {occurred_at, recorded_at}`，排序方向 `order ∈ {asc, desc}`。
- 支援 `source_project` 過濾：`source_project` 可為單值或清單。
- 若未提供 `sort_by`，請求應被拒絕並回傳明確錯誤（提示可用值）。

---

### 使用者故事 3 - 管理推播偏好與授權（優先度：P3）

使用者可更新接收通知的種類與頻率，其他專案在發送提醒前可即時檢查或訂閱偏好變動。

**為何此優先**：確保所有提醒遵循同一授權來源，避免違反 Never Break Userspace。

**獨立測試**：透過 API 更新推播偏好後，模擬 snowbuddy-matching 查詢偏好並獲得更新值。

**驗收情境**：

1. **Given** 使用者調整通知設定，**When** 偏好被儲存，**Then** 系統記錄變更時間與來源並觸發事件給訂閱者。
2. **Given** 子專案在發送提醒前查詢偏好，**When** 呼叫偏好查詢接口，**Then** 取得最新授權並遵守停用設定。

#### 撤回授權之排程取消責任
- 當使用者撤回全部推播授權時，user-core 僅發布變更事件（ChangeFeed）；實際取消既有排程通知由通知系統（事件消費者）負責。

### 邊界情況（Edge Cases）

- 使用者同時擁有教練與學生身份時，身份標記應合併顯示且避免產生兩筆主檔。
- 累積上報延遲導致 `recorded_at` 晚於 `occurred_at` 時，排序行為遵循呼叫端指定的 `sort_by`。
- 行為事件 payload 遺漏必填欄位時，應拒收並回報具體欄位名稱。
- 使用者撤回所有推播授權後，需確認既有排程任務自動取消通知。

## 需求（強制）

### 功能性需求（Functional Requirements）

- **FR-001**：系統必須能建立、更新、查詢、停用單一 `User ID` 主檔，並記錄操作歷史。
- **FR-002**：系統必須支援角色標記（學生、教練、雙重身份）與語言、滑雪經驗、擅長雪場、教學語言等欄位。
- **FR-003**：系統必須提供標準化的行為事件寫入 API，驗證 schema 並存入具備時間戳與來源的紀錄。
- **FR-004**：系統必須提供依 `User ID` 查詢行為事件的接口，支援時間排序與來源濾器。
- **FR-005**：系統必須集中管理推播偏好（提醒類型、頻率、啟用狀態）並提供即時查詢。
- **FR-006**：系統必須在主檔或偏好更新時發布變更事件供其他專案訂閱。
- **FR-007**：系統必須阻止重複主檔（同身份識別碼）並提供合併流程（需要澄清：合併流程的操作角色與工具尚未決定）。
- **FR-008**：系統必須記錄資料變更審計資訊（操作者、時間、欄位、舊值、新值）。
- **FR-009**：系統必須支援跨國身份資訊延伸（如台灣身分證、香港身份證、護照），並透過 `UserLocaleProfile` 以安全方式儲存與驗證。

### 關鍵實體（Key Entities）

- **UserProfile**：代表單一滑雪者主檔，含 `User ID`、基本資料、角色標記、語言、滑雪經驗、擅長雪場、教學語言與審計欄位。
- **BehaviorEvent**：代表跨專案寫入的事件，含 `event_id`、`user_id`、`event_type`、`source_project`、`occurred_at`、`payload`（JSON 依 schema 驗證）。
- **NotificationPreference**：代表使用者對不同提醒類型的授權，含 `user_id`、`channel`、`status`（`opt-in`/`opt-out`/`paused`）、`frequency`、`last_updated_at`。
- **ChangeFeed**：代表推播給其他專案的變更事件，含 `entity_type`、`entity_id`、`change_type`、`payload`、`published_at`。

## 成功準則（強制）

### 可量化成果（Measurable Outcomes）

- **SC-001**：100% 的新建主檔在 2 秒內完成並可立即被其他專案查詢。
- **SC-002**：行為事件寫入 API 每日成功率 ≥ 99.5%，失敗案例提供明確欄位錯誤訊息。
- **SC-003**：既有專案遷移後無重複主檔產生，資料稽核顯示重複率 0%。
- **SC-004**：推播偏好查詢延遲 < 200ms（p95），且偏好更新 1 分鐘內同步到所有訂閱專案。

## 實作狀態（2025-10-19）

┌────────┬────────┬──────────────────────────────────────────┐
│ 條目   │ 狀態   │ 備註                                     │
├────────┼────────┼──────────────────────────────────────────┤
│ FR-001 │ Done   │ `/users` 建立/更新/停用 API 皆可用並寫入變更事件 │
│ FR-002 │ Done   │ 角色、語言、滑雪經驗等欄位於主檔完整支援       │
│ FR-003 │ Done   │ `/events` 寫入驗證核心事件 schema，支援 `schema_url` │
│ FR-004 │ Done   │ `/events/by-user` 強制排序與來源過濾            │
│ FR-005 │ Done   │ `/users/{id}/preferences` 集中管理推播偏好        │
│ FR-006 │ Done   │ 變更統一寫入 `change_feed.payload` 並透過 webhook 發佈 │
│ FR-007 │ Done   │ `/users/{id}/merge` 端點提供主檔合併與狀態標記    │
│ FR-008 │ Done   │ change feed payload 含 actor 與 diff 供稽核        │
│ FR-009 │ Done   │ `UserLocaleProfile` 維持多國身分資料               │
└────────┴────────┴──────────────────────────────────────────┘
