# 需求文檔 - 加強雪伴匹配功能

## 簡介

本需求文檔旨在加強 SnowTrace 平台的雪伴匹配功能。目前系統已有基礎的匹配框架，但缺乏智能的候選人過濾、精準的匹配演算法，以及與行程規劃的深度整合。本次增強將提升匹配準確度、效能，並改善使用者體驗。

## 術語表

- **系統 (System)**: SnowTrace 雪伴匹配系統
- **使用者 (User)**: 使用平台的滑雪愛好者
- **行程 (Trip)**: 使用者創建的滑雪行程
- **雪伴 (Buddy)**: 潛在的滑雪夥伴
- **匹配分數 (Match Score)**: 用於評估兩個使用者的匹配程度
- **候選人 (Candidate)**: 經過初步篩選的潛在匹配對象
- **搜尋者 (Seeker)**: 發起匹配搜尋的使用者
- **目標使用者 (Target)**: 被搜尋的潛在雪伴
- **匹配偏好 (Matching Preference)**: 使用者的匹配偏好設定
- **行程可見性 (Trip Visibility)**: 私密、好友可見、公開
- **技能等級 (Skill Level)**: 滑雪技能等級（初學者、中級、高級、專家）
- **雪場 (Resort)**: 滑雪場
- **雪季 (Season)**: 滑雪季節

## Requirements

### 需求 1

**使用者故事：** 作為一名規劃滑雪行程的使用者，我希望系統能自動尋找符合我行程細節的潛在雪伴，以便我能輕鬆地與合適的滑雪夥伴建立連結。

#### 驗收標準

1. WHEN 使用者創建一個可見性設為「公開」或「好友可見」的新行程 THEN 系統 SHALL 根據行程細節自動啟動雪伴匹配搜尋
2. WHEN 匹配搜尋完成 THEN 系統 SHALL 儲存搜尋結果並將其與行程關聯
3. WHEN 使用者查看行程詳情 THEN 系統 SHALL 顯示推薦雪伴列表及匹配分數
4. WHEN 行程的 max_buddies 大於零 THEN 系統 SHALL 只顯示可能加入的候選人
5. WHEN 行程日期或雪場被更新 THEN 系統 SHALL 使用更新後的條件觸發新的匹配搜尋

### 需求 2

**使用者故事：** 作為一名搜尋雪伴的使用者，我希望系統在計分前有效率地過濾候選人，以便我只看到相關的匹配結果且搜尋能快速完成。

#### 驗收標準

1. WHEN 啟動匹配搜尋 THEN 系統 SHALL 在計算匹配分數前根據基本條件過濾候選人
2. WHEN 過濾候選人 THEN 系統 SHALL 排除已封鎖搜尋者或被搜尋者封鎖的使用者
3. WHEN 過濾候選人 THEN 系統 SHALL 排除技能等級超出偏好設定可接受範圍的使用者
4. WHEN 過濾候選人 THEN 系統 SHALL 只包含至少有一個重疊偏好雪場或地區的使用者
5. WHEN 過濾候選人 THEN 系統 SHALL 只包含可用時間與搜尋者日期重疊的使用者
6. WHEN 過濾後的候選人池為空 THEN 系統 SHALL 回傳空結果集並附上適當的訊息

### 需求 3

**使用者故事：** 作為一名使用者，我希望匹配演算法能準確考慮多個維度，以便我能收到高品質的雪伴推薦。

#### 驗收標準

1. WHEN 計算匹配分數 THEN 系統 SHALL 分別計算時間相容性、地點相容性和技能等級相容性的分數
2. WHEN 兩個行程有相同的日期和雪場 THEN 系統 SHALL 給予最高可能的匹配分數
3. WHEN 兩個行程在同一雪場有重疊日期 THEN 系統 SHALL 根據重疊天數計算比例分數
4. WHEN 兩個使用者的技能等級相容且差距在一級以內 THEN 系統 SHALL 給予高技能相容性分數
5. WHEN 計算最終匹配分數 THEN 系統 SHALL 以適當的權重組合所有維度分數
6. WHEN 所有分數計算完成 THEN 系統 SHALL 提供人類可讀的匹配分數原因

### 需求 4

**使用者故事：** 作為一名使用者，我希望能向推薦的匹配對象發送雪伴請求，以便我能與潛在的滑雪夥伴建立連結。

#### 驗收標準

1. WHEN 使用者向一個行程發送雪伴請求 THEN 系統 SHALL 創建一個狀態為「待處理」的 TripBuddy 紀錄
2. WHEN 雪伴請求被創建 THEN 系統 SHALL 紀錄請求訊息和時間戳記
3. WHEN 雪伴請求被發送 THEN 系統 SHALL 向 user-core 發送行為事件以供分析
4. WHEN 使用者嘗試向同一行程發送重複請求 THEN 系統 SHALL 拒絕該請求並回傳錯誤訊息
5. WHEN 行程已達最大容量 THEN 系統 SHALL 拒絕新的雪伴請求並回傳適當的錯誤訊息

### 需求 5

**使用者故事：** 作為行程擁有者，我希望能審查並回應雪伴請求，以便我能控制誰加入我的行程。

#### 驗收標準

1. WHEN 行程擁有者查看待處理的雪伴請求 THEN 系統 SHALL 顯示所有請求及請求者資訊和匹配分數
2. WHEN 行程擁有者接受雪伴請求 THEN 系統 SHALL 更新 TripBuddy 狀態為「已接受」並增加行程的 current_buddies 計數
3. WHEN 行程擁有者拒絕雪伴請求 THEN 系統 SHALL 更新 TripBuddy 狀態為「已拒絕」並紀錄回應訊息
4. WHEN 雪伴請求被接受或拒絕 THEN 系統 SHALL 向 user-core 發送行為事件
5. WHEN 雪伴請求被接受 THEN 系統 SHALL 透過通知系統通知請求者

### 需求 6

**使用者故事：** 作為一名使用者，我希望能探索其他使用者的公開行程，以便我能找到可加入的行程。

#### 驗收標準

1. WHEN 使用者請求探索行程 THEN 系統 SHALL 回傳符合使用者偏好的公開行程列表
2. WHEN 探索行程 THEN 系統 SHALL 依日期範圍、雪場和技能等級要求過濾行程
3. WHEN 顯示行程結果 THEN 系統 SHALL 包含行程詳情、擁有者資訊（匿名化）和可用雪伴名額
4. WHEN 行程已達最大容量 THEN 系統 SHALL 將其從探索結果中排除
5. WHEN 使用者已請求加入某行程 THEN 系統 SHALL 在結果中標示請求狀態

### 需求 7

**使用者故事：** 作為系統管理員，我希望匹配過程具有高效能和可擴展性，以便即使有許多活躍行程，使用者也能快速收到結果。

#### 驗收標準

1. WHEN 啟動匹配搜尋 THEN 系統 SHALL 在 2 秒內完成最多 10,000 名使用者的候選人過濾階段
2. WHEN 計算匹配分數 THEN 系統 SHALL 在 5 秒內處理最多 100 名候選人
3. WHEN 同時請求多個匹配搜尋 THEN 系統 SHALL 以非同步方式處理而不阻塞
4. WHEN 匹配搜尋完成 THEN 系統 SHALL 快取結果至少 1 小時
5. WHEN 行程詳情被更新 THEN 系統 SHALL 使該行程的快取匹配結果失效

### 需求 8

**使用者故事：** 作為一名使用者，我希望系統在匹配時考慮我的社交連結，以便我能優先與朋友滑雪或擴展我的社交網絡。

#### 驗收標準

1. WHEN 計算匹配分數 THEN 系統 SHALL 檢查兩個使用者是否在平台上互相追蹤
2. WHEN 兩個使用者互相追蹤 THEN 系統 SHALL 在匹配分數中加入社交加分
3. WHEN 使用者封鎖另一個使用者 THEN 系統 SHALL 將該使用者從所有匹配結果中排除
4. WHEN 使用者的隱私設定為「僅好友」THEN 系統 SHALL 只向追蹤者顯示其行程
5. WHEN 顯示匹配結果 THEN 系統 SHALL 標示候選人是否為互相追蹤者

### 需求 9

**使用者故事：** 作為一名使用者，我希望系統能根據整體技能等級來匹配雪伴，以便找到程度相近的滑雪夥伴一起進步。

#### 驗收標準

1. WHEN 使用者設定技能等級偏好範圍 THEN 系統 SHALL 接受最小和最大技能等級（初學者、中級、高級、專家）
2. WHEN 匹配候選人 THEN 系統 SHALL 只包含技能等級落在指定範圍內的使用者
3. WHEN 兩個使用者有相同的技能等級 THEN 系統 SHALL 給予最高技能相容性分數
4. WHEN 兩個使用者的技能等級差距在一級以內 THEN 系統 SHALL 給予高技能相容性分數
5. WHEN 兩個使用者的技能等級差距超過兩級 THEN 系統 SHALL 給予低技能相容性分數或排除他們

### 需求 10

**使用者故事：** 作為使用學習系統的使用者，我希望系統能根據我的學習進度和技能掌握度來匹配雪伴，以便找到程度相近且能互相學習的夥伴。

#### 驗收標準

1. WHEN 使用者完成單板教學課程的練習 THEN 系統 SHALL 紀錄使用者在 CASI 五項核心技能的掌握度
2. WHEN 計算匹配分數 THEN 系統 SHALL 考慮兩個使用者在 CASI 核心技能上的相似度
3. WHEN 兩個使用者在相同技能等級且有相似的 CASI 技能分布 THEN 系統 SHALL 給予額外的技能匹配加分
4. WHEN 兩個使用者在某項 CASI 技能上掌握度相近 THEN 系統 SHALL 給予該技能的相容性加分
5. WHEN 顯示匹配結果 THEN 系統 SHALL 顯示候選人在各 CASI 技能上的強項和弱項
6. WHEN 使用者查看匹配詳情 THEN 系統 SHALL 顯示雙方可以一起練習的共同課程建議

### 需求 11

**使用者故事：** 作為想要進步的使用者，我希望系統能根據我最近的練習紀錄來推薦合適的雪伴，以便找到有相似學習目標的夥伴。

#### 驗收標準

1. WHEN 使用者最近完成特定類型課程的練習 THEN 系統 SHALL 在匹配時考慮使用者的當前學習焦點
2. WHEN 兩個使用者最近都在練習相同的技能領域 THEN 系統 SHALL 給予學習目標相似度加分
3. WHEN 使用者收藏特定難度或類型的課程 THEN 系統 SHALL 將此作為技能偏好的參考依據
4. WHEN 使用者在某個技能上的練習評分持續提高 THEN 系統 SHALL 將此視為該技能的積極學習信號
5. WHEN 匹配結果顯示 THEN 系統 SHALL 標示候選人最近正在練習的技能領域
